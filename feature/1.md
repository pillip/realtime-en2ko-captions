# 🎯 [Feature] 사용자 관리 시스템 및 사용량 기반 과금 구현

## 📋 **개요**
MVP 검증 완료 후 프로덕트화를 위한 사용자 관리 시스템 구축 및 OpenAI Realtime API 사용량 기반 과금 시스템 구현

## 🎯 **목표**
- [x] 관리자가 사용자 계정을 생성/관리할 수 있는 시스템 구축
- [x] 사용자별 음성 인식 사용량 추적 및 제한 기능
- [x] 간단한 로그인/인증 시스템 구현
- [x] 실제 음성 길이 기반 정확한 사용량 과금

## 🗄️ **데이터베이스 설계**

### **users 테이블**
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    salt TEXT NOT NULL,
    email TEXT,
    full_name TEXT,
    role TEXT DEFAULT 'user',  -- 'admin', 'user'
    is_active BOOLEAN DEFAULT 1,
    total_usage_seconds INTEGER DEFAULT 0,      -- 총 사용량 (초)
    usage_limit_seconds INTEGER DEFAULT 3600,   -- 사용 가능한 총량 (초)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP
);
```

### **usage_logs 테이블**
```sql
CREATE TABLE usage_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    action TEXT NOT NULL,  -- 'transcribe'
    duration_seconds INTEGER NOT NULL,
    source_language TEXT,
    target_language TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    metadata TEXT,  -- JSON: transcript_length, etc.
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## 🔧 **구현 작업**

### **1. 데이터베이스 레이어 (database.py)**
- [x] SQLite DB 연결 및 스키마 생성
- [x] User 모델 (생성, 인증, 조회, 수정, 삭제)
- [x] UsageLog 모델 (사용량 기록, 조회)
- [x] 비밀번호 해싱 (PBKDF2-SHA256)
- [x] .env 기반 초기 관리자 계정 생성

### **2. 인증 시스템**
- [x] 로그인 페이지 (Streamlit 기반)
- [x] 세션 관리 (st.session_state 활용)
- [x] 권한 체크 미들웨어
- [x] 로그아웃 기능

### **3. 관리자 대시보드 (/admin_dashboard)**
- [x] 사용자 목록 보기 (사용량/남은시간 포함)
- [x] 신규 사용자 생성 폼
- [x] 사용자 정보 수정 (사용량 추가, 활성화/비활성화)
- [x] 사용자 삭제 기능
- [x] 사용 통계 및 로그 조회 (요청 수 기반)
- [ ] 실시간 활성 세션 모니터링

### **4. 사용량 측정 시스템**
- [x] **Frontend**: OpenAI 이벤트에서 실제 음성 길이 추출
  ```javascript
  case 'input_audio_buffer.speech_started':
      speechStartTime = Date.now();
  case 'input_audio_buffer.speech_stopped':
      speechEndTime = Date.now();
  case 'conversation.item.input_audio_transcription.completed':
      const actualDuration = (speechEndTime - speechStartTime) / 1000;
      // 서버로 실제 음성 길이 전송
  ```

- [x] **Backend**: 사용량 체크 및 기록
  ```python
  # transcribe 결과 수신 시
  audio_duration = data.get("audio_duration_seconds", 0)

  # 사용량 체크
  if remaining_seconds <= audio_duration:
      # 사용량 초과 시 연결 종료

  # 사용량 기록 (source_text, target_text 포함)
  User.add_usage(user_id, audio_duration)
  UsageLog.record(user_id, 'transcribe', audio_duration, metadata={
      'source_text': transcript,
      'target_text': translated_text
  })
  ```

### **5. UI/UX 개선**
- [x] 메인 페이지에 사용량 표시 (아이디, 소속, 사용량 진행바)
- [x] 사용량 부족 시 경고 메시지
- [x] 관리자 대시보드 디자인
- [x] 로그인 페이지 디자인
- [x] 신규 사용자 생성 완료 시 시각적 피드백

## 📁 **파일 구조**
```
├── database.py          # DB 모델 및 연결 관리
├── auth.py             # 인증 관련 유틸리티
├── admin.py            # 관리자 대시보드 페이지
├── login.py            # 로그인 페이지
├── app.py              # 메인 애플리케이션 (사용량 체크 로직 추가)
├── components/
│   └── webrtc.html     # 실제 음성 길이 측정 로직 추가
├── data/
│   └── app.db          # SQLite 데이터베이스
└── .env                # 관리자 계정 정보
```

## 🔐 **보안 고려사항**
- [x] 비밀번호 해싱 (PBKDF2-SHA256 + Salt)
- [x] 세션 토큰 보안
- [x] SQL Injection 방지 (parameterized queries)
- [x] 관리자 계정 .env 관리
- [x] 입력값 검증

## 📊 **사용량 측정 방식**
1. **OpenAI Speech Events**: `speech_started` → `speech_stopped` 시간 차이로 실제 음성 길이 측정
2. **Fallback**: 타이밍 정보 없을 시 텍스트 길이 기반 추정 (`len(text) / 5.0` 초)
3. **실시간 체크**: 매 transcribe 완료 시점에 사용량 확인 및 초과 시 즉시 차단

## ⚡ **우선순위**
1. **High**: Database + User 모델 구현
2. **High**: 관리자 대시보드 (계정 생성 필수)
3. **High**: 사용량 측정 및 제한 로직
4. **Medium**: 로그인 시스템
5. **Low**: UI/UX 개선

## 🧪 **테스트 케이스**
- [x] 관리자 계정 생성 및 로그인
- [x] 일반 사용자 계정 생성
- [x] 사용량 정확한 측정 및 기록
- [x] 사용량 초과 시 서비스 차단
- [x] 사용량 추가 부여 기능

## 📈 **성공 기준**
- [x] 관리자가 웹 UI를 통해 사용자 계정을 쉽게 생성/관리할 수 있음
- [x] 사용자별 음성 인식 사용량이 정확히 측정되고 제한됨
- [x] 사용량 초과 시 자동으로 서비스 차단됨
- [x] 모든 사용 기록이 로그로 남아 추후 분석 가능 (source_text, target_text 포함)

## 📝 **추가 개선사항**
- [x] 사용자 정보 UI: "사용자" → "아이디", "이름" → "소속", "역할" 제거
- [x] 사용량 통계: "세션 수" → "요청 수"로 레이블 변경
- [x] 사용자 삭제 기능 추가 (관련 로그 연쇄 삭제)
- [x] 신규 사용자 생성 완료 시 성공 메시지 개선
- [x] metadata에 원문/번역문 저장 기능

## 🏷️ **Labels**
`enhancement` `database` `authentication` `admin-panel` `billing` `priority-high`
